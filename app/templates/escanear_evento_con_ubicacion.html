<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Verificando ubicación</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/escanear_evento_con_ubicacion.css') }}">
</head>

<!-- Modal QR expirado -->
<div id="mensaje-modal-expirado" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
    <div style="background:white; padding:30px; border-radius:15px; text-align:center; max-width:500px; width:90%; font-size:1.2rem;">
        <h3 style="color:#a30000; font-size:1.5rem;">⚠ QR expirado</h3>
        <p id="mensaje-texto-expirado" style="margin-bottom:15px;"></p>
        <p style="font-size:1rem; color:gray;">Serás redirigido automáticamente...</p>
    </div>
</div>

<!-- Modal QR fuera de fecha -->
<div id="mensaje-modal-fuera" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
    <div style="background:white; padding:30px; border-radius:15px; text-align:center; max-width:500px; width:90%; font-size:1.2rem;">
        <h3 style="color:#a30000; font-size:1.5rem;">⚠ QR fuera de fecha</h3>
        <p id="mensaje-texto-fuera" style="margin-bottom:15px;"></p>
        <p style="font-size:1rem; color:gray;">Serás redirigido automáticamente...</p>
    </div>
</div>

<body>
    <h2>Escaneando evento: {{ evento.nombre_evento }}</h2>
    <p>Verificando ubicación...</p>

<script>
function mostrarModalExpirado(mensaje) {
    document.getElementById('mensaje-texto-expirado').textContent = mensaje;
    document.getElementById('mensaje-modal-expirado').style.display = 'flex';
    setTimeout(() => {
        {% if familia_id %}
            window.location.href = "{{ url_for('perfil_familia', familia_id=familia_id) }}";
        {% else %}
            window.location.href = "{{ url_for('login') }}";
        {% endif %}
    }, 3000);
}

function mostrarModalFuera(mensaje) {
    document.getElementById('mensaje-texto-fuera').textContent = mensaje;
    document.getElementById('mensaje-modal-fuera').style.display = 'flex';
    setTimeout(() => {
        {% if familia_id %}
            window.location.href = "{{ url_for('perfil_familia', familia_id=familia_id) }}";
        {% else %}
            window.location.href = "{{ url_for('login') }}";
        {% endif %}
    }, 3000);
}

navigator.geolocation.getCurrentPosition(
    function(position) {
        const data = {
            lat: position.coords.latitude,
            lon: position.coords.longitude,
            evento_id: {{ evento.id | tojson }}
        };

        fetch("/validar_ubicacion_evento", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(data)
        })
        .then(res => res.json().then(data => ({ status: res.status, body: data })))
        .then(({ status, body }) => {
            console.log("✅ Respuesta del servidor:", body);
            if (status === 200 && body.redirect) {
                window.location.href = body.redirect;
            } else if (body.code === "qr_expirado") {
                mostrarModalExpirado(body.error);
            } else if (body.code === "fuera_de_fecha") {
                mostrarModalFuera(body.error);
            } else if (body.error) {
                alert(body.error);
            } else {
                alert("Ocurrió un error inesperado");
                console.error("❌ Respuesta inesperada:", body);
            }
        })
        .catch(error => {
            alert("No se pudo comunicar con el servidor.");
            console.error("❌ Error en fetch:", error);
        });
    },
    function(error) {
        console.error("❌ Error de geolocalización:", error);
        alert("No se pudo obtener tu ubicación: " + error.message);
    }
);
</script>
</body>
</html>
