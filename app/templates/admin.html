<!DOCTYPE html>
<html lang="es">
<head>   
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de AdministraciÃ³n</title>

    <!-- CSS principal -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" />
</head>

<style>
body {
    background-image: url("{{ url_for('static', filename='img/PRUEBA5.jpg') }}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}
</style>

<body>
<div class="admin-bg"></div>
<div class="admin-contenedor">
    <div class="admin-userbar">
        <span>ğŸ‘¤ Usuario: {{ session.get('nombre_usuario') }}</span>
        <a href="{{ url_for('logout') }}">Cerrar sesiÃ³n</a>
    </div>

    <nav class="admin-navbar" id="admin-navbar">
        <ul>
        {% if rol == 'admin' %}
            <li><a href="{{ url_for('crear_beneficio') }}">ğŸ Crear Beneficio</a></li>
            <li><a href="{{ url_for('lista_administradores') }}">ğŸ§‘â€ğŸ’¼ Ver Usuarios</a></li>
            <li><a href="{{ url_for('lista_familias') }}">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familias</a></li>
            <li><a href="{{ url_for('crear_qr_evento') }}">ğŸ“¸ Eventos</a></li>
            <li><a href="{{ url_for('crear_lugar') }}">ğŸ“ Crear Lugar Frecuente</a></li>
            <li><a href="{{ url_for('puntos_masivos') }}">ğŸ—³ï¸ Puntos Masivos</a></li>
            <li><a href="{{ url_for('lista_familias_eliminar') }}">ğŸ—‘ï¸ Eliminar Familias</a></li>
            <li><a href="{{ url_for('log') }}">ğŸ’½ Log</a></li>
        {% elif rol == 'supervisor' %}
            <!-- Otras opciones de supervisor aquÃ­ -->
        {% endif %}
        </ul>
    </nav>

    <!-- Mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, msg in messages %}
                    <div class="flash {{ category }}">{{ msg }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <h1>Panel de AdministraciÃ³n</h1>

    <h2>Escaneo de Eventos (Staff)</h2>
    <form method="get" id="form-ir-a-evento" class="evento-form">
        <label for="selector-evento"><strong>Selecciona un evento:</strong></label><br />
        <select id="selector-evento">
            <option value="">-- Elegir evento --</option>
            {% for evento in eventos %}
                <option value="{{ url_for('vista_escaneo_evento', evento_id=evento.id) }}">
                    {{ evento.nombre_evento }} - {{ evento.puntos }} puntos
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Ir</button>
    </form>

{% if rol in ['admin', 'supervisor'] %}
    <h2>Familias Registradas</h2>

    <form id="formImportarExcel" method="POST" action="/importar_excel_familias" enctype="multipart/form-data" style="margin-top: 2em;">
        <label for="excelFile"><strong>ğŸ“¥ Importar familias desde Excel:</strong></label>
        <input type="file" name="excelFile" id="excelFile" accept=".xlsx" required style="margin: 0.5em;">
        <button type="submit" class="btn">Subir archivo</button>
    </form>

    <div class="table-responsive">
        <table id="tabla-familias" class="display">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>ContraseÃ±a</th>
                    <th>Puntos</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for f in familias %}
                <tr>
                    <td>{{ f.id }}</td>
                    <td>{{ f.nombre }}</td>
                    <td>{{ f.correo }}</td>
                    <td>{{ f.password }}</td>
                    <td>{{ f.puntos }}</td>
                    <td class="acciones">
                        <a href="{{ url_for('ver_familia', familia_id=f.id) }}"> Ver</a>
                        <a href="{{ url_for('editar_familia', familia_id=f.id) }}">âœï¸ Editar</a>
                        {% if rol == 'admin' %}
                            <button onclick="sumar({{ f.id }})" class="sumar" title="Sumar puntos">â•</button>
                        {% endif %}
                        <button onclick="canjear({{ f.id }})" class="canjear" title="Canjear puntos">â–</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}

{% if rol == 'admin' %}
    <h2>Eventos con QR</h2>
    <h3>ğŸ†• Ãšltimo evento</h3>
    {% if ultimo_evento %}
        <div class="evento">
            <p><strong>{{ ultimo_evento.nombre_evento }}</strong> â€” {{ ultimo_evento.puntos }} puntos</p>
            <a href="{{ url_for('static', filename='qr_eventos/' + ultimo_evento.qr_filename) }}" target="_blank">
                <img src="{{ url_for('static', filename='qr_eventos/' + ultimo_evento.qr_filename) }}" width="200" loading="lazy" />
            </a><br />
            <a href="{{ url_for('descargar_pdf_qr_evento', evento_id=ultimo_evento.id) }}" class="btn btn-volver">ğŸ“¥ Descargar QR (PDF)</a>
            <form action="{{ url_for('eliminar_evento', evento_id=ultimo_evento.id) }}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('Â¿EstÃ¡s seguro de eliminar este evento?')" class="btn btn-danger">ğŸ—‘ Eliminar</button>
            </form>
        </div>
    {% else %}
        <p>No hay eventos registrados aÃºn.</p>
    {% endif %}

    <hr />

    <button onclick="toggleEventos()" class="btn-volver">ğŸ“‚ Ver eventos anteriores</button>
    <div id="eventos-anteriores" style="display: none; margin-top: 20px;">
        {% for evento in otros_eventos %}
        <div class="evento">
            <p><strong>{{ evento.nombre_evento }}</strong> â€” {{ evento.puntos }} puntos</p>
            <a href="{{ url_for('static', filename='qr_eventos/' + evento.qr_filename) }}" target="_blank">
                <img src="{{ url_for('static', filename='qr_eventos/' + evento.qr_filename) }}" width="150" loading="lazy" />
            </a><br />
            <a href="{{ url_for('descargar_pdf_qr_evento', evento_id=evento.id) }}" class="btn btn-primary">ğŸ“¥ Descargar QR (PDF)</a>
            <form action="{{ url_for('eliminar_evento', evento_id=evento.id) }}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('Â¿EstÃ¡s seguro de eliminar este evento?')" class="btn btn-danger">ğŸ—‘ Eliminar</button>
            </form>
        </div>
        {% endfor %}
    </div>

    <hr />
    <h2>âš ï¸ Reseteo de base de datos</h2>
    <p>Para comenzar un nuevo ciclo escolar, puedes resetear todos los datos de familias, eventos y puntos.</p>
    <button onclick="mostrarConfirmacion()" class="btn-danger">ğŸ”„ Resetear base de datos</button>

    <!-- Modal 1 -->
    <div id="modalConfirmacion" class="admin-modal" style="display:none;">
        <div class="admin-modal-box">
            <h3>âš ï¸ ConfirmaciÃ³n</h3>
            <p>Esta acciÃ³n eliminarÃ¡ permanentemente todos los datos de familias, transacciones, beneficios y eventos.</p>
            <p>Â¿EstÃ¡s seguro de continuar?</p>
            <div class="acciones">
                <button onclick="solicitarPassword()" class="btn-danger">SÃ­, continuar</button>
                <button onclick="cerrarModal()" class="btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal 2 -->
    <div id="modalPassword" class="admin-modal" style="display:none;">
        <div class="admin-modal-box">
            <h3>ğŸ” ConfirmaciÃ³n de identidad</h3>
            <label for="passwordInput">Ingresa tu contraseÃ±a para confirmar:</label><br>
            <input type="password" id="passwordInput" required style="margin-top: 0.5em; padding: 0.5em; width: 100%; max-width: 300px; border-radius: 7px; border: 1px solid #ccc;">
            <div class="acciones" style="margin-top: 1em;">
                <button onclick="enviarReseteo()" class="btn-danger">Confirmar reseteo</button>
                <button type="button" onclick="cerrarModal()" class="btn">Cancelar</button>
            </div>
        </div>
    </div>
{% endif %}
</div><!-- admin-contenedor -->

<!-- LibrerÃ­as externas -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

<!-- Script personalizado -->
<script>
document.getElementById("form-ir-a-evento").addEventListener("submit", function(e) {
    e.preventDefault();
    const url = document.getElementById("selector-evento").value;
    if (url) {
        window.location.href = url;
    } else {
        alert("Selecciona un evento vÃ¡lido.");
    }
});

$(document).ready(function () {
    $('#tabla-familias').DataTable({
        language: {
            search: "ğŸ” Buscar:",
            lengthMenu: "Mostrar _MENU_ registros",
            info: "Mostrando _START_ a _END_ de _TOTAL_ familias",
            paginate: { previous: "â†", next: "â†’" },
            zeroRecords: "No se encontraron coincidencias",
        },
        pageLength: 10,
        lengthMenu: [5, 10, 20, 50, 100],
        dom: 'Bfrtip',
        buttons: [
        {
            extend: 'excelHtml5',
            text: '<i class="fas fa-file-excel"></i> Exportar a Excel',
            className: 'btn-excel',
            title: 'Lista de Familias',
            exportOptions: { columns: ':visible:not(:last-child)' }
        }
]
    });
});

function toggleEventos() {
    const div = document.getElementById("eventos-anteriores");
    const btn = event.target;
    const visible = div.style.display === "block";
    div.style.display = visible ? "none" : "block";
    btn.textContent = visible ? "ğŸ“‚ Ver eventos anteriores" : "ğŸ”¼ Ocultar eventos anteriores";
}

function mostrarMensaje(texto, tipo = 'exito') {
    let mensajeDiv = document.getElementById('mensaje');
    if (!mensajeDiv) {
        mensajeDiv = document.createElement('div');
        mensajeDiv.id = 'mensaje';
        document.body.insertBefore(mensajeDiv, document.body.firstChild);
    }

    mensajeDiv.textContent = texto;
    mensajeDiv.style.display = 'block';
    mensajeDiv.style.padding = '12px';
    mensajeDiv.style.margin = '12px';
    mensajeDiv.style.borderRadius = '6px';
    mensajeDiv.style.fontWeight = 'bold';

    if (tipo === 'error') {
        mensajeDiv.style.backgroundColor = '#f8d7da';
        mensajeDiv.style.color = '#721c24';
        mensajeDiv.style.border = '1px solid #f5c6cb';
    } else {
        mensajeDiv.style.backgroundColor = '#d4edda';
        mensajeDiv.style.color = '#155724';
        mensajeDiv.style.border = '1px solid #c3e6cb';
    }

    setTimeout(() => {
        mensajeDiv.style.display = 'none';
    }, 4000);
}

function sumar(id) {
    const puntos = prompt("Â¿CuÃ¡ntos puntos deseas sumar?");
    if (!puntos || isNaN(puntos)) return;

    const motivo = prompt("Motivo de la acreditaciÃ³n:");
    if (!motivo) return;

    fetch('/transaccion', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            familia_id: id,
            puntos: parseInt(puntos),
            tipo: "suma",
            descripcion: motivo
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            mostrarMensaje(data.error, 'error');
        } else {
            mostrarMensaje(data.mensaje, 'exito');
            location.reload();
        }
    });
}

function canjear(id) {
    const puntos = prompt("Â¿CuÃ¡ntos puntos deseas canjear?");
    if (!puntos || isNaN(puntos)) return;

    const motivo = prompt("Motivo del canje:");
    if (!motivo) return;

    fetch('/transaccion', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            familia_id: id,
            puntos: parseInt(puntos),
            tipo: "canje",
            descripcion: motivo
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            mostrarMensaje(data.error, 'error');
        } else {
            mostrarMensaje(data.mensaje, 'exito');
            location.reload();
        }
    });
}

function mostrarConfirmacion() {
    document.getElementById("modalConfirmacion").style.display = "flex";
}
function solicitarPassword() {
    document.getElementById("modalConfirmacion").style.display = "none";
    document.getElementById("modalPassword").style.display = "flex";
}
function cerrarModal() {
    document.getElementById("modalConfirmacion").style.display = "none";
    document.getElementById("modalPassword").style.display = "none";
}

async function enviarReseteo() {
    const password = document.getElementById("passwordInput").value.trim();
    if (!password) return alert("Debes ingresar tu contraseÃ±a.");

    try {
        const response = await fetch("/resetear_base_datos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password })
        });

        if (!response.ok) throw new Error("Error en el reseteo");

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = response.headers.get("Content-Disposition").split("filename=")[1].replace(/"/g, "");
        document.body.appendChild(a);
        a.click();
        a.remove();

        mostrarMensaje("âœ… Base de datos reiniciada y respaldo descargado.");
        cerrarModal();

        setTimeout(() => {
            location.reload();
        }, 3000);

    } catch (error) {
        console.error("Fallo el reseteo:", error);
        mostrarMensaje("âŒ Error al intentar resetear la base de datos", "error");
    }
}

setTimeout(function() {
    let flashMessages = document.querySelectorAll('.flash');
    flashMessages.forEach(function(msg) {
        msg.style.transition = "opacity 1s ease";
        msg.style.opacity = "0";
        setTimeout(() => msg.remove(), 1000);
    });
}, 4000);
</script>
</body>
</html>
