<!DOCTYPE html>
<html lang="es">
<head>   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de AdministraciÃ³n</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head> 
<body>
    <p><a href="/logout">Cerrar sesiÃ³n</a></p>
    <nav class="admin-navbar">
<ul>
    <li><a href="{{ url_for('crear_beneficio') }}">ğŸ Crear Beneficio</a></li>
    <li><a href="{{ url_for('lista_administradores') }}">ğŸ§‘â€ğŸ’¼ Ver Administradores</a></li>
    <li><a href="{{ url_for('crear_admin') }}">â• Nuevo Administrador</a></li>
    <li><a href="{{ url_for('lista_familias') }}">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Agregar Familia</a></li>
    <li><a href="{{ url_for('crear_qr_evento') }}">ğŸ“¸ Crear QR Evento</a></li>
</ul>
</nav>
    
    <h1>Panel de AdministraciÃ³n</h1>

    <h2>Escaneo de Eventos (Staff)</h2>
<form method="get" id="form-ir-a-evento" style="margin-bottom: 30px;">
    <label for="selector-evento"><strong>Selecciona un evento:</strong></label><br>
    <select id="selector-evento" style="padding: 8px; width: 300px;">
        <option value="">-- Elegir evento --</option>
        {% for evento in eventos %}
            <option value="{{ url_for('vista_escaneo_evento', evento_id=evento.id) }}">
                {{ evento.nombre_evento }} - {{ evento.puntos }} puntos
            </option>
        {% endfor %}
    </select>
    <button type="submit" style="padding: 8px 12px; margin-left: 10px;">Ir</button>
</form>

<script>
document.getElementById("form-ir-a-evento").addEventListener("submit", function(e) {
    e.preventDefault();
    const url = document.getElementById("selector-evento").value;
    if (url) {
        window.location.href = url;
    } else {
        alert("Selecciona un evento vÃ¡lido.");
    }
});
</script>

    <div id="mensaje"></div>

    <input type="text" id="busqueda" placeholder="Buscar familia..." oninput="filtrarFamilias()">

    <table id="tabla-familias">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>ContraseÃ±a</th>
                <th>Puntos</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Eventos con QR</h2>
    <table>
        <thead>
            <tr>
                <th>Nombre del Evento</th>
                <th>Puntos</th>
                <th>QR</th>
            </tr>
        </thead>
        <tbody>
            {% for evento in eventos %}
            <tr>
                <td>{{ evento.nombre_evento }}</td>
                <td>{{ evento.puntos }}</td>
                <td>
                <a href="{{ url_for('static', filename='qr_eventos/' + evento.qr_filename) }}" target="_blank">
                <img src="{{ url_for('static', filename='qr_eventos/' + evento.qr_filename) }}" width="150" title="Haz clic para ampliar">
                </a>
                <br>
                <a href="{{ url_for('descargar_qr_evento', filename=evento.qr_filename) }}" class="btn btn-primary">ğŸ“¥ Descargar QR</a>
                </a>
                <form action="{{ url_for('eliminar_evento', evento_id=evento.id) }}" method="post" style="display:inline;">
                <button type="submit" onclick="return confirm('Â¿EstÃ¡s seguro de eliminar este evento?')" class="btn btn-danger">
                ğŸ—‘ Eliminar
        </button>
    </form>
</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function mostrarMensaje(texto, tipo = 'exito') {
            const mensajeDiv = document.getElementById('mensaje');
            mensajeDiv.textContent = texto;
            mensajeDiv.style.display = 'block';
            mensajeDiv.style.backgroundColor = tipo === 'error' ? '#f8d7da' : '#d4edda';
            mensajeDiv.style.color = tipo === 'error' ? '#721c24' : '#155724';
            mensajeDiv.style.border = tipo === 'error' ? '1px solid #f5c6cb' : '1px solid #c3e6cb';

            setTimeout(() => {
                mensajeDiv.style.display = 'none';
            }, 4000);
        }

        let familias = [];

        async function cargarFamilias() {
            const res = await fetch('/familias');
            familias = await res.json();
            mostrarFamilias(familias);
        }

        function mostrarFamilias(lista) {
            const tbody = document.querySelector('#tabla-familias tbody');
            tbody.innerHTML = '';
            lista.forEach(f => {
                tbody.innerHTML += `
                    <tr>
                        <td>${f.id}</td>
                        <td>${f.nombre}</td>
                        <td>${f.correo}</td>
                        <td>${f.password}</td>
                        <td>${f.puntos}</td>
                        <td>
                            <a href="/familia/${f.id}/ver">Ver</a> |
                            <button onclick="sumar(${f.id})">â•</button>
                            <button onclick="canjear(${f.id})">â–</button>
                        </td>
                    </tr>
                `;
            });
        }

        function filtrarFamilias() {
            const texto = document.getElementById('busqueda').value.toLowerCase();
            const filtradas = familias.filter(f =>
                f.nombre.toLowerCase().includes(texto) ||
                f.correo.toLowerCase().includes(texto)
            );
            mostrarFamilias(filtradas);
        }

        function sumar(id) {
            const puntos = prompt("Â¿CuÃ¡ntos puntos deseas sumar?");
            if (!puntos || isNaN(puntos)) return;

            const motivo = prompt("Motivo de la acreditaciÃ³n:");
            if (!motivo) return;

            fetch('/transaccion', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    familia_id: id,
                    puntos: parseInt(puntos),
                    tipo: "suma",
                    descripcion: motivo
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    mostrarMensaje(data.error, 'error');
                } else {
                    mostrarMensaje(data.mensaje, 'exito');
                    cargarFamilias();
                }
            });
        }

        function canjear(id) {
            const puntos = prompt("Â¿CuÃ¡ntos puntos deseas canjear?");
            if (!puntos || isNaN(puntos)) return;

            const motivo = prompt("Motivo del canje:");
            if (!motivo) return;

            fetch('/transaccion', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    familia_id: id,
                    puntos: parseInt(puntos),
                    tipo: "canje",
                    descripcion: motivo
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    mostrarMensaje(data.error, 'error');
                } else {
                    mostrarMensaje(data.mensaje, 'exito');
                    cargarFamilias();
                }
            });
        }

        cargarFamilias();
    </script>
</body>
</html>
