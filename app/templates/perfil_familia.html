<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de {{ familia.nombre }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/perfil_familia.css') }}">
</head>

<style>
body {
    background-image: url("{{ url_for('static', filename='img/PRUPUESTA_PARTE2.jpg') }}");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

/* üî• ESTILOS DEL MODAL DE ESCANEO */
#modal-scanner-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(3px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

#modal-scanner {
    background: #ffffff;
    padding: 18px;
    border-radius: 15px;
    text-align: center;
    width: 95%;
    max-width: 380px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.35);
}

#qr-video-modal {
    width: 100%;
    max-height: 280px;
    object-fit: cover;
    border-radius: 12px;
}

#btn-cerrar-modal {
    margin-top: 12px;
    background: rgb(150, 1, 1);
    color: white;
    padding: 10px 22px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
}

#btn-cerrar-modal:hover {
    background: #8a0000;
}
</style>

<body>

<!-- FLASH -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="mensajes-flash">
        {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
{% endwith %}

<div class="container">

    <div class="header">
        <h1>üë®‚Äçüë©‚Äçüëß ¬°Hola, {{ familia.nombre }}!</h1>
        <a class="logout" href="{{ url_for('logout_familia') }}">üîì Cerrar sesi√≥n</a>
    </div>

    <div class="puntos">
        <h2>Puntos actuales: <span>{{ familia.puntos }}</span></h2>
    </div>

    <div class="qr-section">
        <h1>Tu c√≥digo QR</h1>

        <div class="qr-wrapper">
            <img src="{{ url_for('static', filename='qr/familia_' ~ familia.id ~ '.png') }}?v={{ familia.qr_version }}" alt="QR de la familia">

            <form method="GET" action="{{ url_for('descargar_pdf_qr_familia', familia_id=familia.id) }}">
                <button class="btn-download" type="submit">üì• Descargar QR (PDF)</button>
            </form>

            {% if ultimo_evento %}
                <!-- BOT√ìN QUE ACTIVA EL MODAL -->
                <button id="btn-escanear">üì∑ Escanear nuevo evento</button>

            {% else %}
                <p style="color: gray; text-align: center;">No hay eventos disponibles para escanear.</p>
            {% endif %}
        </div>
    </div>

    <!-- HISTORIAL -->
    <div class="historial">
        <h2>üìú Historial de transacciones</h2>
        {% if transacciones %}
            <div class="transacciones-scroll">
                {% for t in transacciones %}
                <div class="transaccion-card">
                    <p class="fecha">{{ t.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                    <p class="detalle">
                        <strong>
                            {% if t.tipo == 'suma' %}
                                ‚úÖ Ganaste
                            {% elif t.tipo == 'canje' %}
                                üîª Canjeaste
                            {% elif t.tipo == 'penalizacion' %}
                                ‚ö†Ô∏è Penalizaci√≥n de
                            {% else %}
                                {{ t.tipo }}
                            {% endif %}
                            {{ t.puntos }} puntos
                        </strong>
                    </p>
                    <p class="descripcion">{{ t.descripcion or 'Sin descripci√≥n' }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No hay transacciones registradas.</p>
        {% endif %}
    </div>

    <!-- BENEFICIOS -->
    <div class="beneficios">
        <h2>üéÅ Beneficios disponibles</h2>
        {% if beneficios %}
            <table>
                <thead>
                    <tr>
                        <th>Beneficio</th>
                        <th>Puntos requeridos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for beneficio in beneficios %}
                    <tr>
                        <td>{{ beneficio.nombre }}</td>
                        <td>{{ beneficio.puntos_requeridos }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No hay beneficios disponibles actualmente.</p>
        {% endif %}
    </div>

</div>

<!-- üî• MODAL COMPLETO DEL ESCANEO -->
<div id="modal-scanner-overlay">
    <div id="modal-scanner">
        <video id="qr-video-modal"></video>
        <p id="modal-scan-status">üì∑ Apunta al c√≥digo del evento</p>
        <button id="btn-cerrar-modal">Cerrar</button>
    </div>
</div>

<script src="{{ url_for('static', filename='js/qr-scanner.min.js') }}"></script>

<script>
const overlay = document.getElementById("modal-scanner-overlay");
const modalVideo = document.getElementById("qr-video-modal");
const modalStatus = document.getElementById("modal-scan-status");
const closeModal = document.getElementById("btn-cerrar-modal");
const scanButton = document.getElementById("btn-escanear");

let scannerModal = null;

scanButton?.addEventListener("click", () => {
    overlay.style.display = "flex";
    document.body.style.overflow = "hidden"; // üî• Bloquea scroll del fondo
    if (!scannerModal) {
        scannerModal = new QrScanner(modalVideo, result => {
            modalStatus.textContent = "‚è≥ Validando...";
            scannerModal.stop();

            try {
                const url = new URL(result);
                const path = url.pathname;

                if (path.startsWith("/escanear_evento/")) {
                    const eventoId = path.split("/")[2];

                    navigator.geolocation.getCurrentPosition(pos => {
                        fetch("/validar_qr_evento", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                evento_id: eventoId,
                                lat: pos.coords.latitude,
                                lon: pos.coords.longitude
                            })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.redirect) {
                                window.location.href = data.redirect;
                            } else {
                                alert(data.error || "Ocurri√≥ un error");
                            }
                        });
                    }, () => alert("No se pudo obtener ubicaci√≥n"));
                } else {
                    alert("QR inv√°lido");
                    scannerModal.start();
                }

            } catch {
                alert("Error al procesar el QR");
                scannerModal.start();
            }
        });
    }

    QrScanner.hasCamera().then(hasCam => {
        if (!hasCam) return alert("No se detect√≥ c√°mara");
        scannerModal.start();
        modalStatus.textContent = "üì∑ Apunta al c√≥digo del evento";
    });
});

closeModal.addEventListener("click", () => {
    overlay.style.display = "none";
    scannerModal?.stop();

    document.body.style.overflow = "auto";
});
</script>

</body>
</html>
