<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">

    <title>Perfil de Familia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/familia.css') }}">

    <!-- ‚úÖ DataTables y jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>

<body>
<div class="admin-contenedor">
    <a href="{{ url_for('lista_familias') }}" class="btn-volver">‚Üê Volver al panel</a>
    <h1>Familia: {{ familia.nombre }}</h1>
    <p>Puntos actuales: <strong>{{ familia.puntos }}</strong></p>

    <!-- C√≥digo QR centrado -->
    <div class="qr-container">
        <h3>C√≥digo QR:</h3>
        <img src="{{ url_for('static', filename='qr/familia_' ~ familia.id ~ '.png') }}?v={{ familia.qr_version or 1 }}" alt="QR">
        <form action="{{ url_for('generar_o_regenerar_qr', familia_id=familia.id) }}" 
            method="POST" 
            style="margin-top: 1em;"
            onsubmit="return confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto anular√° el QR anterior.')">
            <button type="submit" class="btn-volver">Generar/Actualizar c√≥digo QR</button>
        </form>

        <a href="{{ url_for('descargar_qr_pdf', familia_id=familia.id) }}"
            class="btn-volver"
            style="margin-left: 10px;">
            Descargar QR (PDF)
        </a>
    </div>

    <!-- Bot√≥n Exportar historial -->
    <a href="{{ url_for('exportar_transacciones', familia_id=familia.id) }}" class="btn-export">
        üì• Exportar historial a Excel (CSV)
    </a>

    <!-- Filtrar historial -->
    <h2>Filtrar historial</h2>
    <form method="GET" class="filter-form">
        <label for="tipo">Tipo de transacci√≥n:</label>
        <select name="tipo" id="tipo">
            <option value="">-- Todos --</option>
            <option value="suma" {% if request.args.get('tipo') == 'suma' %}selected{% endif %}>Acreditaci√≥n</option>
            <option value="canje" {% if request.args.get('tipo') == 'canje' %}selected{% endif %}>Canje</option>
            <option value="penalizacion" {% if request.args.get('tipo') == 'penalizacion' %}selected{% endif %}>Penalizaci√≥n</option>
        </select>

        <label for="fecha_inicio">Desde:</label>
        <input type="date" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">

        <label for="fecha_fin">Hasta:</label>
        <input type="date" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">

        <button type="submit">Filtrar</button>
    </form>

    <h2>Historial de transacciones</h2>
    {% if transacciones %}
    <table id="transactionsTable" class="transactions">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Puntos</th>
                <th>Descripci√≥n</th>
            </tr>
        </thead>
        <tbody>
        {% for transaccion in transacciones %}
            <tr>
                <td>{{ transaccion.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>
                    {% if transaccion.tipo == 'suma' %}
                        Acreditaci√≥n
                    {% elif transaccion.tipo == 'canje' %}
                        Canje
                    {% elif transaccion.tipo == 'penalizacion' %}
                        Penalizaci√≥n
                    {% else %}
                        {{ transaccion.tipo }}
                    {% endif %}
                </td>
                <td>{{ transaccion.puntos }}</td>
                <td>{{ transaccion.descripcion or 'Sin descripci√≥n' }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p><em>No hay transacciones que coincidan con los filtros seleccionados.</em></p>
    {% endif %}

    <h2>Registrar transacci√≥n</h2>
    <form id="transaccionForm" class="transaction-form">
        <label for="tipo_reg">Tipo:</label>

        {% if rol == 'admin' %}
            <select name="tipo" id="tipo_reg" required>
                <option value="suma">Suma</option>
                <option value="canje">Canje</option>
                <option value="penalizacion">Penalizaci√≥n</option>
            </select>

        {% elif rol == 'supervisor' %}
            <select name="tipo" id="tipo_reg" required>
                <option value="canje">Canje</option>
                <option value="penalizacion">Penalizaci√≥n</option>
            </select>

        {% else %}
            <input type="hidden" name="tipo" value="canje">
            <span class="tipo-fijo">Canje</span>
        {% endif %}

        <input type="number" name="puntos" required min="1" placeholder="Cantidad de puntos">
        <input type="text" name="descripcion" placeholder="Descripci√≥n">
        <button type="submit">Registrar</button>
    </form>

    <div id="mensaje-transaccion"></div>
</div> <!-- cierre admin-contenedor -->

<script>
$(document).ready(function() {
    // ‚úÖ Inicializar DataTable
    const table = $("#transactionsTable").DataTable({
        paging: true,
        searching: true,
        info: true,
        order: [[0, "desc"]]
    });

    // ‚úÖ Manejo del formulario
    document.getElementById("transaccionForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            tipo: formData.get("tipo"),
            puntos: formData.get("puntos"),
            descripcion: formData.get("descripcion")
        };

        fetch(`/familia/{{ familia.id }}/transaccion`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(resp => resp.json())
        .then(resp => {
            const div = document.getElementById("mensaje-transaccion");
            div.innerText = resp.mensaje || resp.error;
            div.style.color = resp.mensaje ? "green" : "red";
            setTimeout(() => { div.innerText = ""; }, 4000);

            if (resp.mensaje) {
                // Traducir tipo
                let tipoTexto = "";
                if (data.tipo === "suma") tipoTexto = "Acreditaci√≥n";
                else if (data.tipo === "canje") tipoTexto = "Canje";
                else if (data.tipo === "penalizacion") tipoTexto = "Penalizaci√≥n";

                // Insertar fila nueva en DataTable
                table.row.add([
                    new Date().toLocaleString("es-MX"),
                    tipoTexto,
                    (data.tipo === "suma" ? Number(data.puntos) : -Number(data.puntos)),
                    data.descripcion || "Sin descripci√≥n"
                ]).draw(false);

                // Resetear form
                document.getElementById("transaccionForm").reset();
            }
        })
        .catch(err => {
            console.error("Error:", err);
        });
    });
});
</script>
</body>
</html>
